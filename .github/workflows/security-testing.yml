name: Security Testing Pipeline

on:
  push:
    branches: [main, develop, security/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily security scans at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Security test level'
        required: true
        default: 'full'
        type: choice
        options:
          - critical
          - full
          - infrastructure

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  critical-vulnerability-tests:
    name: Critical Vulnerability Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: sec_latent_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          pip install pytest-xdist pytest-cov

      - name: Run Critical Vulnerability Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass123@localhost:5432/sec_latent_test
          REDIS_URL: redis://localhost:6379/0
          TESTING_MODE: penetration
          ALLOW_DANGEROUS_TESTS: true
        run: |
          pytest tests/security/penetration/test_critical_vulnerabilities.py \
            -v \
            -m critical \
            --maxfail=5 \
            --tb=short \
            --junit-xml=reports/critical-security.xml \
            --cov=src \
            --cov-report=xml:reports/coverage-critical.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-security-results
          path: reports/

      - name: Security Test Summary
        if: always()
        run: |
          echo "## Critical Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/parse_test_results.py reports/critical-security.xml >> $GITHUB_STEP_SUMMARY

      - name: Fail on Critical Vulnerabilities
        if: failure()
        run: |
          echo "::error::Critical security vulnerabilities detected! Review test results."
          exit 1

  advanced-penetration-tests:
    name: Advanced Penetration Tests
    runs-on: ubuntu-latest
    needs: critical-vulnerability-tests
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: sec_latent_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass123
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run Advanced Attack Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass123@localhost:5432/sec_latent_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/security/penetration/test_advanced_attacks.py \
            -v \
            -n auto \
            --junit-xml=reports/advanced-security.xml \
            --cov=src \
            --cov-report=xml:reports/coverage-advanced.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: advanced-security-results
          path: reports/

  infrastructure-security-tests:
    name: Infrastructure Security Tests
    runs-on: ubuntu-latest
    needs: critical-vulnerability-tests
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: sec_latent_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass123
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        command: redis-server --requirepass testredispass
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          pip install docker redis psycopg2-binary

      - name: Run Infrastructure Security Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass123@localhost:5432/sec_latent_test
          REDIS_URL: redis://:testredispass@localhost:6379/0
          REDIS_PASSWORD: testredispass
          POSTGRES_PASSWORD: testpass123
        run: |
          pytest tests/security/penetration/test_infrastructure_security.py \
            -v \
            --junit-xml=reports/infrastructure-security.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-security-results
          path: reports/

  dependency-vulnerability-scan:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install scanning tools
        run: |
          pip install safety pip-audit bandit

      - name: Safety Check
        run: |
          safety check --json --output reports/safety-report.json || true
          safety check --full-report > reports/safety-report.txt || true

      - name: Pip Audit
        run: |
          pip-audit --format json --output reports/pip-audit.json || true

      - name: Bandit Security Linting
        run: |
          bandit -r src/ -f json -o reports/bandit-report.json || true
          bandit -r src/ -f txt -o reports/bandit-report.txt || true

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: reports/

      - name: Dependency Scan Summary
        if: always()
        run: |
          echo "## Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Safety Check" >> $GITHUB_STEP_SUMMARY
          cat reports/safety-report.txt >> $GITHUB_STEP_SUMMARY || echo "No issues found" >> $GITHUB_STEP_SUMMARY

  container-security-scan:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker build -t sec-latent-backend:test -f docker/Dockerfile.backend .
          docker build -t sec-latent-frontend:test -f docker/Dockerfile.frontend ./frontend

      - name: Run Trivy vulnerability scanner - Backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'sec-latent-backend:test'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner - Frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'sec-latent-frontend:test'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'

      - name: Container Scan Summary
        if: always()
        run: |
          echo "## Container Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan completed. Check Security tab for details." >> $GITHUB_STEP_SUMMARY

  secrets-scanning:
    name: Secrets Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-report-generation:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [
      critical-vulnerability-tests,
      advanced-penetration-tests,
      infrastructure-security-tests,
      dependency-vulnerability-scan,
      container-security-scan
    ]
    if: always()
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate Consolidated Report
        run: |
          python scripts/generate_security_report.py \
            --input all-reports/ \
            --output reports/security-summary.md \
            --format markdown

      - name: Upload Consolidated Report
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-report
          path: reports/security-summary.md

      - name: Post Security Report to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Security Testing Results\n\n${report}`
            });

      - name: Check Security Thresholds
        run: |
          python scripts/check_security_thresholds.py all-reports/

  notify-security-team:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: security-report-generation
    if: failure() && github.ref == 'refs/heads/main'
    timeout-minutes: 5

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ CRITICAL: Security vulnerabilities detected in main branch!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security Alert*\n\nCritical vulnerabilities detected in SEC Latent platform.\n\n*Branch:* ${{ github.ref }}\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Results>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
